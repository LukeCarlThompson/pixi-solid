import{X as A,ab as I,J as f,ac as b,ad as ne,l as Y,L as w,ae as P,af as Z,ag as y,ah as C,ai as oe,aj as J,ak as ce,al as T,O as k}from"./pixi-stage.CLjrGBfr.js";import{B as q}from"./BitmapFont.CqF0DmGx.js";const M={test(s){return typeof s=="string"&&s.startsWith("info face=")},parse(s){const e=s.match(/^[a-z]+\s+.+$/gm),t={info:[],common:[],page:[],char:[],chars:[],kerning:[],kernings:[],distanceField:[]};for(const c in e){const p=e[c].match(/^[a-z]+/gm)[0],u=e[c].match(/[a-zA-Z]+=([^\s"']+|"([^"]*)")/gm),m={};for(const g in u){const v=u[g].split("="),_=v[0],O=v[1].replace(/"/gm,""),N=parseFloat(O),ie=isNaN(N)?O:N;m[_]=ie}t[p].push(m)}const a={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},[r]=t.info,[i]=t.common,[o]=t.distanceField??[];o&&(a.distanceField={range:parseInt(o.distanceRange,10),type:o.fieldType}),a.fontSize=parseInt(r.size,10),a.fontFamily=r.face,a.lineHeight=parseInt(i.lineHeight,10);const n=t.page;for(let c=0;c<n.length;c++)a.pages.push({id:parseInt(n[c].id,10)||0,file:n[c].file});const l={};a.baseLineOffset=a.lineHeight-parseInt(i.base,10);const d=t.char;for(let c=0;c<d.length;c++){const p=d[c],u=parseInt(p.id,10);let m=p.letter??p.char??String.fromCharCode(u);m==="space"&&(m=" "),l[u]=m,a.chars[m]={id:u,page:parseInt(p.page,10)||0,x:parseInt(p.x,10),y:parseInt(p.y,10),width:parseInt(p.width,10),height:parseInt(p.height,10),xOffset:parseInt(p.xoffset,10),yOffset:parseInt(p.yoffset,10),xAdvance:parseInt(p.xadvance,10),kerning:{}}}const h=t.kerning||[];for(let c=0;c<h.length;c++){const p=parseInt(h[c].first,10),u=parseInt(h[c].second,10),m=parseInt(h[c].amount,10);a.chars[l[u]].kerning[l[p]]=m}return a}},z={test(s){const e=s;return typeof e!="string"&&"getElementsByTagName"in e&&e.getElementsByTagName("page").length&&e.getElementsByTagName("info")[0].getAttribute("face")!==null},parse(s){const e={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},t=s.getElementsByTagName("info")[0],a=s.getElementsByTagName("common")[0],r=s.getElementsByTagName("distanceField")[0];r&&(e.distanceField={type:r.getAttribute("fieldType"),range:parseInt(r.getAttribute("distanceRange"),10)});const i=s.getElementsByTagName("page"),o=s.getElementsByTagName("char"),n=s.getElementsByTagName("kerning");e.fontSize=parseInt(t.getAttribute("size"),10),e.fontFamily=t.getAttribute("face"),e.lineHeight=parseInt(a.getAttribute("lineHeight"),10);for(let d=0;d<i.length;d++)e.pages.push({id:parseInt(i[d].getAttribute("id"),10)||0,file:i[d].getAttribute("file")});const l={};e.baseLineOffset=e.lineHeight-parseInt(a.getAttribute("base"),10);for(let d=0;d<o.length;d++){const h=o[d],c=parseInt(h.getAttribute("id"),10);let p=h.getAttribute("letter")??h.getAttribute("char")??String.fromCharCode(c);p==="space"&&(p=" "),l[c]=p,e.chars[p]={id:c,page:parseInt(h.getAttribute("page"),10)||0,x:parseInt(h.getAttribute("x"),10),y:parseInt(h.getAttribute("y"),10),width:parseInt(h.getAttribute("width"),10),height:parseInt(h.getAttribute("height"),10),xOffset:parseInt(h.getAttribute("xoffset"),10),yOffset:parseInt(h.getAttribute("yoffset"),10),xAdvance:parseInt(h.getAttribute("xadvance"),10),kerning:{}}}for(let d=0;d<n.length;d++){const h=parseInt(n[d].getAttribute("first"),10),c=parseInt(n[d].getAttribute("second"),10),p=parseInt(n[d].getAttribute("amount"),10);e.chars[l[c]].kerning[l[h]]=p}return e}},G={test(s){return typeof s=="string"&&s.match(/<font(\s|>)/)?z.test(A.get().parseXML(s)):!1},parse(s){return z.parse(A.get().parseXML(s))}},le=[".xml",".fnt"],de={extension:{type:f.CacheParser,name:"cacheBitmapFont"},test:s=>s instanceof q,getCacheableAssets(s,e){const t={};return s.forEach(a=>{t[a]=e,t[`${a}-bitmap`]=e}),t[`${e.fontFamily}-bitmap`]=e,t}},pe={extension:{type:f.LoadParser,priority:I.Normal},name:"loadBitmapFont",id:"bitmap-font",test(s){return le.includes(b.extname(s).toLowerCase())},async testParse(s){return M.test(s)||G.test(s)},async parse(s,e,t){const a=M.test(s)?M.parse(s):G.parse(s),{src:r}=e,{pages:i}=a,o=[],n=a.distanceField?{scaleMode:"linear",alphaMode:"premultiply-alpha-on-upload",autoGenerateMipmaps:!1,resolution:1}:{};for(let c=0;c<i.length;++c){const p=i[c].file;let u=b.join(b.dirname(r),p);u=ne(u,r),o.push({src:u,data:n})}const l=await t.load(o),d=o.map(c=>l[c.src]);return new q({data:a,textures:d},r)},async load(s,e){return await(await A.get().fetch(s)).text()},async unload(s,e,t){await Promise.all(s.pages.map(a=>t.unload(a.texture.source._sourceOrigin))),s.destroy()}};class he{constructor(e,t=!1){this._loader=e,this._assetList=[],this._isLoading=!1,this._maxConcurrent=1,this.verbose=t}add(e){e.forEach(t=>{this._assetList.push(t)}),this.verbose&&console.log("[BackgroundLoader] assets: ",this._assetList),this._isActive&&!this._isLoading&&this._next()}async _next(){if(this._assetList.length&&this._isActive){this._isLoading=!0;const e=[],t=Math.min(this._assetList.length,this._maxConcurrent);for(let a=0;a<t;a++)e.push(this._assetList.pop());await this._loader.load(e),this._isLoading=!1,this._next()}}get active(){return this._isActive}set active(e){this._isActive!==e&&(this._isActive=e,e&&!this._isLoading&&this._next())}}const fe={extension:{type:f.CacheParser,name:"cacheTextureArray"},test:s=>Array.isArray(s)&&s.every(e=>e instanceof Y),getCacheableAssets:(s,e)=>{const t={};return s.forEach(a=>{e.forEach((r,i)=>{t[a+(i===0?"":i+1)]=r})}),t}};async function ee(s){if("Image"in globalThis)return new Promise(e=>{const t=new Image;t.onload=()=>{e(!0)},t.onerror=()=>{e(!1)},t.src=s});if("createImageBitmap"in globalThis&&"fetch"in globalThis){try{const e=await(await fetch(s)).blob();await createImageBitmap(e)}catch{return!1}return!0}return!1}const ue={extension:{type:f.DetectionParser,priority:1},test:async()=>ee("data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A="),add:async s=>[...s,"avif"],remove:async s=>s.filter(e=>e!=="avif")},H=["png","jpg","jpeg"],me={extension:{type:f.DetectionParser,priority:-1},test:()=>Promise.resolve(!0),add:async s=>[...s,...H],remove:async s=>s.filter(e=>!H.includes(e))},ge="WorkerGlobalScope"in globalThis&&globalThis instanceof globalThis.WorkerGlobalScope;function W(s){return ge?!1:document.createElement("video").canPlayType(s)!==""}const Ae={extension:{type:f.DetectionParser,priority:0},test:async()=>W("video/mp4"),add:async s=>[...s,"mp4","m4v"],remove:async s=>s.filter(e=>e!=="mp4"&&e!=="m4v")},ye={extension:{type:f.DetectionParser,priority:0},test:async()=>W("video/ogg"),add:async s=>[...s,"ogv"],remove:async s=>s.filter(e=>e!=="ogv")},ve={extension:{type:f.DetectionParser,priority:0},test:async()=>W("video/webm"),add:async s=>[...s,"webm"],remove:async s=>s.filter(e=>e!=="webm")},we={extension:{type:f.DetectionParser,priority:0},test:async()=>ee("data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA="),add:async s=>[...s,"webp"],remove:async s=>s.filter(e=>e!=="webp")},te=class R{constructor(){this.loadOptions={...R.defaultOptions},this._parsers=[],this._parsersValidated=!1,this.parsers=new Proxy(this._parsers,{set:(e,t,a)=>(this._parsersValidated=!1,e[t]=a,!0)}),this.promiseCache={}}reset(){this._parsersValidated=!1,this.promiseCache={}}_getLoadPromiseAndParser(e,t){const a={promise:null,parser:null};return a.promise=(async()=>{let r=null,i=null;if((t.parser||t.loadParser)&&(i=this._parserHash[t.parser||t.loadParser],t.loadParser&&w(`[Assets] "loadParser" is deprecated, use "parser" instead for ${e}`),i||w(`[Assets] specified load parser "${t.parser||t.loadParser}" not found while loading ${e}`)),!i){for(let o=0;o<this.parsers.length;o++){const n=this.parsers[o];if(n.load&&n.test?.(e,t,this)){i=n;break}}if(!i)return w(`[Assets] ${e} could not be loaded as we don't know how to parse it, ensure the correct parser has been added`),null}r=await i.load(e,t,this),a.parser=i;for(let o=0;o<this.parsers.length;o++){const n=this.parsers[o];n.parse&&n.parse&&await n.testParse?.(r,t,this)&&(r=await n.parse(r,t,this)||r,a.parser=n)}return r})(),a}async load(e,t){this._parsersValidated||this._validateParsers();const a=typeof t=="function"?{...R.defaultOptions,...this.loadOptions,onProgress:t}:{...R.defaultOptions,...this.loadOptions,...t||{}},{onProgress:r,onError:i,strategy:o,retryCount:n,retryDelay:l}=a;let d=0;const h={},c=Z(e),p=P(e,g=>({alias:[g],src:g,data:{}})),u=p.reduce((g,v)=>g+(v.progressSize||1),0),m=p.map(async g=>{const v=b.toAbsolute(g.src);h[g.src]||(await this._loadAssetWithRetry(v,g,{onProgress:r,onError:i,strategy:o,retryCount:n,retryDelay:l},h),d+=g.progressSize||1,r&&r(d/u))});return await Promise.all(m),c?h[p[0].src]:h}async unload(e){const a=P(e,r=>({alias:[r],src:r})).map(async r=>{const i=b.toAbsolute(r.src),o=this.promiseCache[i];if(o){const n=await o.promise;delete this.promiseCache[i],await o.parser?.unload?.(n,r,this)}});await Promise.all(a)}_validateParsers(){this._parsersValidated=!0,this._parserHash=this._parsers.filter(e=>e.name||e.id).reduce((e,t)=>(!t.name&&!t.id?w("[Assets] parser should have an id"):(e[t.name]||e[t.id])&&w(`[Assets] parser id conflict "${t.id}"`),e[t.name]=t,t.id&&(e[t.id]=t),e),{})}async _loadAssetWithRetry(e,t,a,r){let i=0;const{onError:o,strategy:n,retryCount:l,retryDelay:d}=a,h=c=>new Promise(p=>setTimeout(p,c));for(;;)try{this.promiseCache[e]||(this.promiseCache[e]=this._getLoadPromiseAndParser(e,t)),r[t.src]=await this.promiseCache[e].promise;return}catch(c){delete this.promiseCache[e],delete r[t.src],i++;const p=n!=="retry"||i>l;if(n==="retry"&&!p){o&&o(c,t),await h(d);continue}if(n==="skip"){o&&o(c,t);return}throw o&&o(c,t),new Error(`[Loader.load] Failed to load ${e}.
${c}`)}}};te.defaultOptions={onProgress:void 0,onError:void 0,strategy:"throw",retryCount:3,retryDelay:250};let be=te;function B(s,e){if(Array.isArray(e)){for(const t of e)if(s.startsWith(`data:${t}`))return!0;return!1}return s.startsWith(`data:${e}`)}function L(s,e){const t=s.split("?")[0],a=b.extname(t).toLowerCase();return Array.isArray(e)?e.includes(a):a===e}const _e=".json",xe="application/json",Ee={extension:{type:f.LoadParser,priority:I.Low},name:"loadJson",id:"json",test(s){return B(s,xe)||L(s,_e)},async load(s){return await(await A.get().fetch(s)).json()}},Ie=".txt",Be="text/plain",Le={name:"loadTxt",id:"text",extension:{type:f.LoadParser,priority:I.Low,name:"loadTxt"},test(s){return B(s,Be)||L(s,Ie)},async load(s){return await(await A.get().fetch(s)).text()}},Pe=["normal","bold","100","200","300","400","500","600","700","800","900"],ke=[".ttf",".otf",".woff",".woff2"],Oe=["font/ttf","font/otf","font/woff","font/woff2"],Fe=/^(--|-?[A-Z_])[0-9A-Z_-]*$/i;function Te(s){const e=b.extname(s),r=b.basename(s,e).replace(/(-|_)/g," ").toLowerCase().split(" ").map(n=>n.charAt(0).toUpperCase()+n.slice(1));let i=r.length>0;for(const n of r)if(!n.match(Fe)){i=!1;break}let o=r.join(" ");return i||(o=`"${o.replace(/[\\"]/g,"\\$&")}"`),o}const Re=/^[0-9A-Za-z%:/?#\[\]@!\$&'()\*\+,;=\-._~]*$/;function Ce(s){return Re.test(s)?s:encodeURI(s)}const We={extension:{type:f.LoadParser,priority:I.Low},name:"loadWebFont",id:"web-font",test(s){return B(s,Oe)||L(s,ke)},async load(s,e){const t=A.get().getFontFaceSet();if(t){const a=[],r=e.data?.family??Te(s),i=e.data?.weights?.filter(n=>Pe.includes(n))??["normal"],o=e.data??{};for(let n=0;n<i.length;n++){const l=i[n],d=new FontFace(r,`url(${Ce(s)})`,{...o,weight:l});await d.load(),t.add(d),a.push(d)}return y.has(`${r}-and-url`)?y.get(`${r}-and-url`).entries.push({url:s,faces:a}):y.set(`${r}-and-url`,{entries:[{url:s,faces:a}]}),a.length===1?a[0]:a}return w("[loadWebFont] FontFace API is not supported. Skipping loading font"),null},unload(s){const e=Array.isArray(s)?s:[s],t=e[0].family,a=y.get(`${t}-and-url`),r=a.entries.find(i=>i.faces.some(o=>e.indexOf(o)!==-1));r.faces=r.faces.filter(i=>e.indexOf(i)===-1),r.faces.length===0&&(a.entries=a.entries.filter(i=>i!==r)),e.forEach(i=>{A.get().getFontFaceSet().delete(i)}),a.entries.length===0&&y.remove(`${t}-and-url`)}};function V(s,e=1){const t=C.RETINA_PREFIX?.exec(s);return t?parseFloat(t[1]):e}function D(s,e,t){s.label=t,s._sourceOrigin=t;const a=new Y({source:s,label:t}),r=()=>{delete e.promiseCache[t],y.has(t)&&y.remove(t)};return a.source.once("destroy",()=>{e.promiseCache[t]&&(w("[Assets] A TextureSource managed by Assets was destroyed instead of unloaded! Use Assets.unload() instead of destroying the TextureSource."),r())}),a.once("destroy",()=>{s.destroyed||(w("[Assets] A Texture managed by Assets was destroyed instead of unloaded! Use Assets.unload() instead of destroying the Texture."),r())}),a}const Me=".svg",Se="image/svg+xml",je={extension:{type:f.LoadParser,priority:I.Low,name:"loadSVG"},name:"loadSVG",id:"svg",config:{crossOrigin:"anonymous",parseAsGraphicsContext:!1},test(s){return B(s,Se)||L(s,Me)},async load(s,e,t){return e.data?.parseAsGraphicsContext??this.config.parseAsGraphicsContext?$e(s):Ue(s,e,t,this.config.crossOrigin)},unload(s){s.destroy(!0)}};async function Ue(s,e,t,a){const r=await A.get().fetch(s),i=A.get().createImage();i.src=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(await r.text())}`,i.crossOrigin=a,await i.decode();const o=e.data?.width??i.width,n=e.data?.height??i.height,l=e.data?.resolution||V(s),d=Math.ceil(o*l),h=Math.ceil(n*l),c=A.get().createCanvas(d,h),p=c.getContext("2d");p.imageSmoothingEnabled=!0,p.imageSmoothingQuality="high",p.drawImage(i,0,0,o*l,n*l);const{parseAsGraphicsContext:u,...m}=e.data??{},g=new J({resource:c,alphaMode:"premultiply-alpha-on-upload",resolution:l,...m});return D(g,t,s)}async function $e(s){const t=await(await A.get().fetch(s)).text(),a=new oe;return a.svg(t),a}const Ve=`(function () {
    'use strict';

    const WHITE_PNG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=";
    async function checkImageBitmap() {
      try {
        if (typeof createImageBitmap !== "function")
          return false;
        const response = await fetch(WHITE_PNG);
        const imageBlob = await response.blob();
        const imageBitmap = await createImageBitmap(imageBlob);
        return imageBitmap.width === 1 && imageBitmap.height === 1;
      } catch (_e) {
        return false;
      }
    }
    void checkImageBitmap().then((result) => {
      self.postMessage(result);
    });

})();
`;let x=null,$=class{constructor(){x||(x=URL.createObjectURL(new Blob([Ve],{type:"application/javascript"}))),this.worker=new Worker(x)}};$.revokeObjectURL=function(){x&&(URL.revokeObjectURL(x),x=null)};const De=`(function () {
    'use strict';

    async function loadImageBitmap(url, alphaMode) {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(\`[WorkerManager.loadImageBitmap] Failed to fetch \${url}: \${response.status} \${response.statusText}\`);
      }
      const imageBlob = await response.blob();
      return alphaMode === "premultiplied-alpha" ? createImageBitmap(imageBlob, { premultiplyAlpha: "none" }) : createImageBitmap(imageBlob);
    }
    self.onmessage = async (event) => {
      try {
        const imageBitmap = await loadImageBitmap(event.data.data[0], event.data.data[1]);
        self.postMessage({
          data: imageBitmap,
          uuid: event.data.uuid,
          id: event.data.id
        }, [imageBitmap]);
      } catch (e) {
        self.postMessage({
          error: e,
          uuid: event.data.uuid,
          id: event.data.id
        });
      }
    };

})();
`;let E=null;class se{constructor(){E||(E=URL.createObjectURL(new Blob([De],{type:"application/javascript"}))),this.worker=new Worker(E)}}se.revokeObjectURL=function(){E&&(URL.revokeObjectURL(E),E=null)};let X=0,S;class Ne{constructor(){this._initialized=!1,this._createdWorkers=0,this._workerPool=[],this._queue=[],this._resolveHash={}}isImageBitmapSupported(){return this._isImageBitmapSupported!==void 0?this._isImageBitmapSupported:(this._isImageBitmapSupported=new Promise(e=>{const{worker:t}=new $;t.addEventListener("message",a=>{t.terminate(),$.revokeObjectURL(),e(a.data)})}),this._isImageBitmapSupported)}loadImageBitmap(e,t){return this._run("loadImageBitmap",[e,t?.data?.alphaMode])}async _initWorkers(){this._initialized||(this._initialized=!0)}_getWorker(){S===void 0&&(S=navigator.hardwareConcurrency||4);let e=this._workerPool.pop();return!e&&this._createdWorkers<S&&(this._createdWorkers++,e=new se().worker,e.addEventListener("message",t=>{this._complete(t.data),this._returnWorker(t.target),this._next()})),e}_returnWorker(e){this._workerPool.push(e)}_complete(e){this._resolveHash[e.uuid]&&(e.error!==void 0?this._resolveHash[e.uuid].reject(e.error):this._resolveHash[e.uuid].resolve(e.data),delete this._resolveHash[e.uuid])}async _run(e,t){await this._initWorkers();const a=new Promise((r,i)=>{this._queue.push({id:e,arguments:t,resolve:r,reject:i})});return this._next(),a}_next(){if(!this._queue.length)return;const e=this._getWorker();if(!e)return;const t=this._queue.pop(),a=t.id;this._resolveHash[X]={resolve:t.resolve,reject:t.reject},e.postMessage({data:t.arguments,uuid:X++,id:a})}reset(){this._workerPool.forEach(e=>e.terminate()),this._workerPool.length=0,Object.values(this._resolveHash).forEach(({reject:e})=>{e?.(new Error("WorkerManager has been reset before completion"))}),this._resolveHash={},this._queue.length=0,this._initialized=!1,this._createdWorkers=0}}const K=new Ne,ze=[".jpeg",".jpg",".png",".webp",".avif"],Ge=["image/jpeg","image/png","image/webp","image/avif"];async function He(s,e){const t=await A.get().fetch(s);if(!t.ok)throw new Error(`[loadImageBitmap] Failed to fetch ${s}: ${t.status} ${t.statusText}`);const a=await t.blob();return e?.data?.alphaMode==="premultiplied-alpha"?createImageBitmap(a,{premultiplyAlpha:"none"}):createImageBitmap(a)}const ae={name:"loadTextures",id:"texture",extension:{type:f.LoadParser,priority:I.High,name:"loadTextures"},config:{preferWorkers:!0,preferCreateImageBitmap:!0,crossOrigin:"anonymous"},test(s){return B(s,Ge)||L(s,ze)},async load(s,e,t){let a=null;globalThis.createImageBitmap&&this.config.preferCreateImageBitmap?this.config.preferWorkers&&await K.isImageBitmapSupported()?a=await K.loadImageBitmap(s,e):a=await He(s,e):a=await new Promise((i,o)=>{a=A.get().createImage(),a.crossOrigin=this.config.crossOrigin,a.src=s,a.complete?i(a):(a.onload=()=>{i(a)},a.onerror=o)});const r=new J({resource:a,alphaMode:"premultiply-alpha-on-upload",resolution:e.data?.resolution||V(s),...e.data});return D(r,t,s)},unload(s){s.destroy(!0)}},Xe=[".mp4",".m4v",".webm",".ogg",".ogv",".h264",".avi",".mov"];let j,U;function Ke(s,e,t){t===void 0&&!e.startsWith("data:")?s.crossOrigin=Ye(e):t!==!1&&(s.crossOrigin=typeof t=="string"?t:"anonymous")}function Qe(s){return new Promise((e,t)=>{s.addEventListener("canplaythrough",a),s.addEventListener("error",r),s.load();function a(){i(),e()}function r(o){i(),t(o)}function i(){s.removeEventListener("canplaythrough",a),s.removeEventListener("error",r)}})}function Ye(s,e=globalThis.location){if(s.startsWith("data:"))return"";e||(e=globalThis.location);const t=new URL(s,document.baseURI);return t.hostname!==e.hostname||t.port!==e.port||t.protocol!==e.protocol?"anonymous":""}function Ze(){const s=[],e=[];for(const t of Xe){const a=T.MIME_TYPES[t.substring(1)]||`video/${t.substring(1)}`;W(a)&&(s.push(t),e.includes(a)||e.push(a))}return{validVideoExtensions:s,validVideoMime:e}}const Je={name:"loadVideo",id:"video",extension:{type:f.LoadParser,name:"loadVideo"},test(s){if(!j||!U){const{validVideoExtensions:a,validVideoMime:r}=Ze();j=a,U=r}const e=B(s,U),t=L(s,j);return e||t},async load(s,e,t){const a={...T.defaultOptions,resolution:e.data?.resolution||V(s),alphaMode:e.data?.alphaMode||await ce(),...e.data},r=document.createElement("video"),i={preload:a.autoLoad!==!1?"auto":void 0,"webkit-playsinline":a.playsinline!==!1?"":void 0,playsinline:a.playsinline!==!1?"":void 0,muted:a.muted===!0?"":void 0,loop:a.loop===!0?"":void 0,autoplay:a.autoPlay!==!1?"":void 0};Object.keys(i).forEach(l=>{const d=i[l];d!==void 0&&r.setAttribute(l,d)}),a.muted===!0&&(r.muted=!0),Ke(r,s,a.crossorigin);const o=document.createElement("source");let n;if(a.mime)n=a.mime;else if(s.startsWith("data:"))n=s.slice(5,s.indexOf(";"));else if(!s.startsWith("blob:")){const l=s.split("?")[0].slice(s.lastIndexOf(".")+1).toLowerCase();n=T.MIME_TYPES[l]||`video/${l}`}return o.src=s,n&&(o.type=n),new Promise(l=>{const d=async()=>{const h=new T({...a,resource:r});r.removeEventListener("canplay",d),e.data.preload&&await Qe(r),l(D(h,t,s))};a.preload&&!a.autoPlay&&r.load(),r.addEventListener("canplay",d),r.appendChild(o)})},unload(s){s.destroy(!0)}},re={extension:{type:f.ResolveParser,name:"resolveTexture"},test:ae.test,parse:s=>({resolution:parseFloat(C.RETINA_PREFIX.exec(s)?.[1]??"1"),format:s.split(".").pop(),src:s})},qe={extension:{type:f.ResolveParser,priority:-2,name:"resolveJson"},test:s=>C.RETINA_PREFIX.test(s)&&s.endsWith(".json"),parse:re.parse};class et{constructor(){this._detections=[],this._initialized=!1,this.resolver=new C,this.loader=new be,this.cache=y,this._backgroundLoader=new he(this.loader),this._backgroundLoader.active=!0,this.reset()}async init(e={}){if(this._initialized){w("[Assets]AssetManager already initialized, did you load before calling this Assets.init()?");return}if(this._initialized=!0,e.defaultSearchParams&&this.resolver.setDefaultSearchParams(e.defaultSearchParams),e.basePath&&(this.resolver.basePath=e.basePath),e.bundleIdentifier&&this.resolver.setBundleIdentifier(e.bundleIdentifier),e.manifest){let i=e.manifest;typeof i=="string"&&(i=await this.load(i)),this.resolver.addManifest(i)}const t=e.texturePreference?.resolution??1,a=typeof t=="number"?[t]:t,r=await this._detectFormats({preferredFormats:e.texturePreference?.format,skipDetections:e.skipDetections,detections:this._detections});this.resolver.prefer({params:{format:r,resolution:a}}),e.preferences&&this.setPreferences(e.preferences),e.loadOptions&&(this.loader.loadOptions={...this.loader.loadOptions,...e.loadOptions})}add(e){this.resolver.add(e)}async load(e,t){this._initialized||await this.init();const a=Z(e),r=P(e).map(n=>{if(typeof n!="string"){const l=this.resolver.getAlias(n);return l.some(d=>!this.resolver.hasKey(d))&&this.add(n),Array.isArray(l)?l[0]:l}return this.resolver.hasKey(n)||this.add({alias:n,src:n}),n}),i=this.resolver.resolve(r),o=await this._mapLoadToResolve(i,t);return a?o[r[0]]:o}addBundle(e,t){this.resolver.addBundle(e,t)}async loadBundle(e,t){this._initialized||await this.init();let a=!1;typeof e=="string"&&(a=!0,e=[e]);const r=this.resolver.resolveBundle(e),i={},o=Object.keys(r);let n=0;const l=[],d=()=>{t?.(l.reduce((c,p)=>c+p,0)/n)},h=o.map((c,p)=>{const u=r[c],m=Object.values(u),v=[...new Set(m.flat())].reduce((_,O)=>_+(O.progressSize||1),0);return l.push(0),n+=v,this._mapLoadToResolve(u,_=>{l[p]=_*v,d()}).then(_=>{i[c]=_})});return await Promise.all(h),a?i[e[0]]:i}async backgroundLoad(e){this._initialized||await this.init(),typeof e=="string"&&(e=[e]);const t=this.resolver.resolve(e);this._backgroundLoader.add(Object.values(t))}async backgroundLoadBundle(e){this._initialized||await this.init(),typeof e=="string"&&(e=[e]);const t=this.resolver.resolveBundle(e);Object.values(t).forEach(a=>{this._backgroundLoader.add(Object.values(a))})}reset(){this.resolver.reset(),this.loader.reset(),this.cache.reset(),this._initialized=!1}get(e){if(typeof e=="string")return y.get(e);const t={};for(let a=0;a<e.length;a++)t[a]=y.get(e[a]);return t}async _mapLoadToResolve(e,t){const a=[...new Set(Object.values(e))];this._backgroundLoader.active=!1;const r=await this.loader.load(a,t);this._backgroundLoader.active=!0;const i={};return a.forEach(o=>{const n=r[o.src],l=[o.src];o.alias&&l.push(...o.alias),l.forEach(d=>{i[d]=n}),y.set(l,n)}),i}async unload(e){this._initialized||await this.init();const t=P(e).map(r=>typeof r!="string"?r.src:r),a=this.resolver.resolve(t);await this._unloadFromResolved(a)}async unloadBundle(e){this._initialized||await this.init(),e=P(e);const t=this.resolver.resolveBundle(e),a=Object.keys(t).map(r=>this._unloadFromResolved(t[r]));await Promise.all(a)}async _unloadFromResolved(e){const t=Object.values(e);t.forEach(a=>{y.remove(a.src)}),await this.loader.unload(t)}async _detectFormats(e){let t=[];e.preferredFormats&&(t=Array.isArray(e.preferredFormats)?e.preferredFormats:[e.preferredFormats]);for(const a of e.detections)e.skipDetections||await a.test()?t=await a.add(t):e.skipDetections||(t=await a.remove(t));return t=t.filter((a,r)=>t.indexOf(a)===r),t}get detections(){return this._detections}setPreferences(e){this.loader.parsers.forEach(t=>{t.config&&Object.keys(t.config).filter(a=>a in e).forEach(a=>{t.config[a]=e[a]})})}}const F=new et;k.handleByList(f.LoadParser,F.loader.parsers).handleByList(f.ResolveParser,F.resolver.parsers).handleByList(f.CacheParser,F.cache.parsers).handleByList(f.DetectionParser,F.detections);k.add(fe,me,ue,we,Ae,ye,ve,Ee,Le,We,je,ae,Je,pe,de,re,qe);const Q={loader:f.LoadParser,resolver:f.ResolveParser,cache:f.CacheParser,detection:f.DetectionParser};k.handle(f.Asset,s=>{const e=s.ref;Object.entries(Q).filter(([t])=>!!e[t]).forEach(([t,a])=>k.add(Object.assign(e[t],{extension:e[t].extension??a})))},s=>{const e=s.ref;Object.keys(Q).filter(t=>!!e[t]).forEach(t=>k.remove(e[t]))});export{F as A};
