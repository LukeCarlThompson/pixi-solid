# Publish pixi-solid to npm (pnpm). Skips publish if the package version is already published.
# Triggers:
#  - push to main (real publish)
#  - manual run (workflow_dispatch) â€” does a dry-run by default
name: Publish pixi-solid to NPM

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/pixi-solid
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Enable pnpm (Corepack)
        run: corepack enable && corepack prepare pnpm@latest --activate

      # Add this step to explicitly configure pnpm auth
      - name: Configure pnpm auth
        if: steps.check_published.outputs.published == 'false'
        run: |
          pnpm config set registry https://registry.npmjs.org/
          pnpm config set //registry.npmjs.org/:_authToken "${{ secrets.NPM_TOKEN }}"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Test
        run: pnpm test

      - name: Check if version is already published
        id: check_published
        run: |
          pkg_name=$(node -e "console.log(require('./package.json').name)")
          pkg_version=$(node -e "console.log(require('./package.json').version)")
          echo "name=$pkg_name" >> $GITHUB_OUTPUT
          echo "version=$pkg_version" >> $GITHUB_OUTPUT
          if npm view "$pkg_name@$pkg_version" --registry=https://registry.npmjs.org/ >/dev/null 2>&1; then
            echo "published=true" >> $GITHUB_OUTPUT
          else
            echo "published=false" >> $GITHUB_OUTPUT
          fi

      - name: Warn and skip publish if version already exists
        if: steps.check_published.outputs.published == 'true'
        run: |
          echo "::warning::Package ${{ steps.check_published.outputs.name }}@${{ steps.check_published.outputs.version }} is already published to npm. Publish will be skipped."

      - name: Debug .npmrc content # This step will now show the .npmrc created by pnpm config set
        if: steps.check_published.outputs.published == 'false'
        run: cat ~/.npmrc | grep "//registry.npmjs.org/:_authToken=" || echo ".npmrc line not found or token missing"

      - name: Verify npm auth (safe)
        if: steps.check_published.outputs.published == 'false'
        run: pnpm whoami --registry=https://registry.npmjs.org/ || true # Use pnpm whoami for consistency

      - name: Publish (dry-run for manual runs)
        if: github.event_name == 'workflow_dispatch' && steps.check_published.outputs.published == 'false'
        run: pnpm publish --access public --dry-run

      - name: Publish (real on push to main)
        if: github.event_name == 'push' && steps.check_published.outputs.published == 'false'
        run: pnpm publish --access public